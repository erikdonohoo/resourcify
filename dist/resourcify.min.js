/*! resourcify 18-12-2014 v0.5.1 */
!function(a,b){"use strict";function c(){function b(b){this.$cache={},this.$options=a.extend({id:"id",saveMethod:"POST",key:["id"]},b),this.$lists={}}return b.prototype.add=function(b,c){for(var d=this.getKey(b),e=this.$cache,f=0;f<d.length-1;f++)e[d[f]]||(e[d[f]]={}),e=e[d[f]];if(e[d[d.length-1]])return a.extend(e[d[d.length-1]],b),e[d[d.length-1]];c&&a.forEach(this.$lists,function(a){a.$invalid=!0});var g=this;return b.$clearCache=function(){g.remove(g.getKey(this))}.bind(b),e[d[d.length-1]]=b},b.prototype.getKey=function(b){var c=[],d=a.isArray(this.$options.key)?this.$options.key:[this.$options.key];return d.forEach(function(a){c.push(b[a])}),c},b.prototype.remove=function(b){a.isArray(b)||(b=[b]);for(var c=this.$cache,d=0;d<b.length-1;d++)c=c[b[d]];delete c[b[b.length-1]]},b.prototype.clear=function(){this.$cache={},this.$lists={}},b.prototype.get=function(b){a.isArray(b)||(b=[b]);for(var c=this.$cache,d=0;d<b.length-1;d++)c=c[b[d]];return c[b[b.length-1]]},b.prototype.getList=function(a){return this.$lists[a]?this.$lists[a]:null},b.prototype.addList=function(b,c){return this.$lists[b]?a.forEach(c,function(c){var d=!1;c=this.add(c),a.forEach(this.$lists[b],function(a){c===a&&(d=!0)}.bind(this)),d||this.$lists[b].push(c)}.bind(this)):(this.$lists[b]=c,a.forEach(c,function(a){this.add(a)}.bind(this))),this.$lists[b]},{createCache:function(a){return new b(a)}}}function d(a,b){return new Function("return function (call) { return function "+a+" () { return call(this, arguments) }; };")()(Function.apply.bind(b))}function e(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("("))}function f(b){function c(){b.apply(this,arguments)}c.prototype=new b;for(var d in b)b.hasOwnProperty(d)&&(c[d]=a.copy(b[d]));return c}function g(c,g,h,i){function j(b,c,h){if(!b||!c)throw new Error("Must supply a name and a url when constructing");this.url=g.when(c),this.name=b,this.config=h||{},this.subs=[];var j=this;this.$$ResourceConstructor=d(this.name,function(b){a.extend(this,b||{}),a.forEach(j.subs,function(a){var b=a[0],c=a[1],d=e(b),g=f(b);g.prototype.$paramMap=c,g.prototype.$parentItem=this,this[d]=g},this),(j.config.constructor||a.noop).bind(this)(b)}),this.$$ResourceConstructor.$$builder=this,this.config.cache&&(this.cache=i.createCache(a.isObject(this.config.cache)?this.config.cache:{}),this.$$ResourceConstructor.$clearCache=this.cache.clear)}function k(b,c){if(!b.method||!b.name)throw new Error("Request config must contain a HTTP method and a name");b.url=b.url?g.when(b.url):null,b.$Const=c,b.isInstance?(c.prototype[b.name]=o(b),b.$Const.$$builder.cache&&(c.prototype[b.name].force=o(a.extend({$force:!0},b)))):(c[b.name]=o(b),b.$Const.$$builder.cache&&(c[b.name].force=o(a.extend({$force:!0},b))))}function l(d,e,f,g,h,i){function j(){e.$resolved=!0,e.$url=d,g(e),f.$defer.resolve(e)}var k={url:d,method:f.method},l=f.$Const.$$builder.cache;if(l&&!f.noCache&&!f.$force)if(a.isArray(e)){var m=l.getList(d);if(m&&!m.$invalid)return m.$promise=e.$promise,e=m,void j()}else{var n=l.get(l.getKey(a.extend(f.params,e)));if(n&&!n.$invalid)return n.$promise=e.$promise,e=n,void j()}k.data=/^(POST|PUT|PATCH|DELETE)$/i.test(f.method)?e:b,c(k).then(function(b){if(f.isArray&&!a.isArray(b.data)||!f.isArray&&a.isArray(b.data))throw new Error("Saw array or object when expecting the opposite when making "+f.method+" call to "+d);f.isArray?(a.forEach(b.data,function(a){var b="object"==typeof a?i.prototype instanceof f.$Const?new i(a):new f.$Const(a):{data:a};b.$invalid=f.invalidateListModels&&l,e.push(b)}),l&&!f.noCache&&(e=l.addList(d,e))):(e="object"==typeof b.data?a.extend(e,b.data):a.extend(e,{data:b.data}),l&&!f.noCache&&(e=l.add(e,f.method===l.$options.saveMethod))),l&&(e.$invalid=!1),e.$response=b,j()},function(a){h(a),f.$defer.reject(a)})}function m(b,c,d,e){var f={};return b.$parentItem&&(f=m(b.$parentItem,c,d,e+1)),a.forEach(d,function(a,c){var d,g;-1!==a.indexOf("@")?(d=a.substr(0,a.indexOf("@")),g=parseInt(a.substr(a.indexOf("@")+1))):(d=a,g=0),g&&g===e&&b[d]?f[c]=b[d]:0===g&&b[d]&&(f[c]=b[d])}),c=a.extend(f,c)}function n(b,c){return b.$parentItem&&(c=n(b.$parentItem,c)),a.forEach(b,function(a,d){b.hasOwnProperty(d)&&(c[d]=a)}),c}function o(b){return function(c,d,e){var f=this,i=this instanceof b.$Const?this:b.isArray?[]:this.prototype instanceof b.$Const?new this({}):new b.$Const({}),j=b.$Const.$$builder.cache;a.isFunction(c)?(e=d||a.noop,d=c,c={}):(c=c||{},d=d||a.noop,e=e||a.noop);var k={};return(this.$parentItem||this.prototype&&this.prototype.$parentItem)&&(this.$paramMap||this.prototype&&this.prototype.$paramMap?c=m(this.$parentItem||this.prototype.$parentItem,c,this.$paramMap||this.prototype.$paramMap,1):k=n(this.$parentItem||this.prototype.$parentItem,k)),b.$defer=g.defer(),b.params=c,i.$promise=b.$defer.promise,i.$resolved=!1,(b.url||b.$Const.$$builder.url).then(function(a){l(h.replaceParams(c,a,i,k),i,b,d,e,f)}.bind(this),function(){throw new Error("Could not resolve URL for "+b.toString())}),j||b.$Const.$$builder.config.usePromise?i.$promise:i}}return j.prototype.subResource=function(a,b){return this.subs.push([a,b]),this},j.prototype.method=function(a,b){return this.$$ResourceConstructor.prototype[a]=b,this},j.prototype.request=function(a){return k(a,this.$$ResourceConstructor),this},j.prototype.create=function(){return this.$$ResourceConstructor},j}function h(a){var b={},c=a.substring(a.indexOf("?"));return c!==a&&c.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(a,c,d,e){b[c]=e}),b}function i(){function b(b,c,d,e){var f,g=/[\/=.](:\w*[a-zA-Z]\w*)/,i=a.copy(c),j="__|cut|__",k=a.copy(b);d=d||{},e=e||{};var l=h(i),m={};for(-1!==i.indexOf("?")&&(i=i.substring(0,i.indexOf("?"))),a.forEach(l,function(a,b){var c=a.substring(1);":"===a.charAt(0)&&(k[c]||d[c]||e[c])?(m[b]=k[c]||d[c]||e[c],delete k[c]):":"!==a.charAt(0)&&(m[b]=a)});f=g.exec(i);){var n=f[1],o=f[1].substring(1);if(i=i.replace(n,k[o]||d[o]||e[o]||j),k[o])delete k[o];else if(-1!==i.indexOf("/"+j)){i=i.substring(0,i.indexOf("/"+j));break}}k=a.extend({},m,k);var p=[];return a.forEach(k,function(a,b){p.push(b+"="+a)}),i+=(p.length?"?":"")+p.join("&")}return{replaceParams:b}}a.module("resourcify",[]),a.module("resourcify").factory("ResourcifyCache",c),g.$inject=["$http","$q","resourcifyUtils","ResourcifyCache"],a.module("resourcify").service("Resourcify",g),a.module("resourcify").factory("resourcifyUtils",i)}(angular);